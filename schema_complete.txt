-- ===============================================================================================
--  GURUKUL OS - MASTER UNIFIED SCHEMA
--  Version: 11.0.0 (Comprehensive Role-Based System)
--  Description: Single authoritative schema for complete school management system
--  Roles: Super Admin, School Admin, Teacher, Student, Parent/Guardian, Transport, E-commerce
-- ===============================================================================================

-- ===============================================================================================
-- 1. CORE INFRASTRUCTURE TABLES
-- ===============================================================================================

-- Drop existing fragmented schemas and recreate unified structure
DROP TABLE IF EXISTS public.admission_documents CASCADE;
DROP TABLE IF EXISTS public.document_requirements CASCADE;
DROP TABLE IF EXISTS public.admissions CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;

-- Enhanced user profiles with comprehensive role support
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    display_name TEXT,
    phone TEXT,
    role TEXT,
    profile_completed BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    branch_id INT,
    created_at TIMESTAMPTZ DEFAULT now(),
    email_confirmed_at TIMESTAMPTZ,
    -- Common fields for all users
    profile_photo_url TEXT,
    address TEXT,
    city TEXT,
    state TEXT,
    country TEXT,
    pin_code TEXT,
    date_of_birth DATE,
    gender TEXT,
    emergency_contact TEXT,
    -- Audit fields
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- School branches and organizational structure
CREATE TABLE IF NOT EXISTS public.school_branches (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name TEXT NOT NULL,
    address TEXT,
    city TEXT,
    state TEXT,
    country TEXT,
    is_main_branch BOOLEAN DEFAULT false,
    admin_name TEXT,
    admin_phone TEXT,
    admin_email TEXT,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Linked', 'Pending')),
    academic_year_start DATE,
    academic_year_end DATE,
    grade_range_start TEXT,
    grade_range_end TEXT,
    contact_person_name TEXT,
    contact_person_phone TEXT,
    contact_person_email TEXT,
    established_date DATE,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Departments within branches
CREATE TABLE IF NOT EXISTS public.school_departments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    hod_id UUID REFERENCES public.profiles(id),
    teacher_count INT DEFAULT 0,
    course_count INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ===============================================================================================
-- 2. ACADEMIC MANAGEMENT TABLES
-- ===============================================================================================

-- Academic years
CREATE TABLE IF NOT EXISTS public.academic_years (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    year_name TEXT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    is_current BOOLEAN DEFAULT false,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Completed')),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Classes/grades structure
CREATE TABLE IF NOT EXISTS public.school_classes (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    academic_year_id BIGINT REFERENCES public.academic_years(id),
    name TEXT NOT NULL,
    grade_level TEXT NOT NULL,
    section TEXT,
    academic_year TEXT,
    class_teacher_id UUID REFERENCES public.profiles(id),
    department_id BIGINT REFERENCES public.school_departments(id),
    capacity INT DEFAULT 30,
    student_count INT DEFAULT 0,
    description TEXT,
    room_number TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Subjects/Courses
CREATE TABLE IF NOT EXISTS public.courses (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    department_id BIGINT REFERENCES public.school_departments(id),
    title TEXT NOT NULL,
    code TEXT UNIQUE,
    grade_level TEXT,
    description TEXT,
    credits INT DEFAULT 1,
    category TEXT,
    subject_type TEXT DEFAULT 'Academic' CHECK (subject_type IN ('Academic', 'Elective', 'Co-curricular', 'Sports', 'Arts')),
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Draft', 'Archived', 'Pending', 'Inactive')),
    syllabus TEXT,
    objectives TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Teacher-subject-class assignments
CREATE TABLE IF NOT EXISTS public.teacher_subject_assignments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    teacher_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    course_id BIGINT REFERENCES public.courses(id) ON DELETE CASCADE,
    class_id BIGINT REFERENCES public.school_classes(id) ON DELETE CASCADE,
    academic_year TEXT,
    workload_hours INT DEFAULT 1,
    is_primary BOOLEAN DEFAULT false,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Pending')),
    assigned_at TIMESTAMPTZ DEFAULT now()
);

-- Student enrollments
CREATE TABLE IF NOT EXISTS public.student_enrollments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    class_id BIGINT REFERENCES public.school_classes(id) ON DELETE CASCADE,
    academic_year TEXT,
    enrollment_date DATE DEFAULT CURRENT_DATE,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Transferred', 'Graduated', 'Dropped')),
    roll_number TEXT,
    student_id_number TEXT,
    parent_guardian_details TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Timetable/scheduling
CREATE TABLE IF NOT EXISTS public.class_timetables (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    class_id BIGINT REFERENCES public.school_classes(id) ON DELETE CASCADE,
    day_of_week TEXT CHECK (day_of_week IN ('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday')),
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    course_id BIGINT REFERENCES public.courses(id),
    teacher_id UUID REFERENCES public.profiles(id),
    room_number TEXT,
    subject_name TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Attendance tracking
CREATE TABLE IF NOT EXISTS public.attendance_records (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    class_id BIGINT REFERENCES public.school_classes(id) ON DELETE CASCADE,
    attendance_date DATE NOT NULL,
    status TEXT DEFAULT 'Present' CHECK (status IN ('Present', 'Absent', 'Late', 'Excused')),
    notes TEXT,
    marked_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(student_id, class_id, attendance_date)
);

-- Assignments and homework
CREATE TABLE IF NOT EXISTS public.assignments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    course_id BIGINT REFERENCES public.courses(id) ON DELETE CASCADE,
    class_id BIGINT REFERENCES public.school_classes(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    instructions TEXT,
    assignment_type TEXT DEFAULT 'Homework' CHECK (assignment_type IN ('Homework', 'Project', 'Quiz', 'Exam', 'Lab')),
    due_date TIMESTAMPTZ,
    total_marks INT DEFAULT 100,
    attachments TEXT[],
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Draft', 'Published', 'Closed')),
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Assignment submissions
CREATE TABLE IF NOT EXISTS public.assignment_submissions (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    assignment_id BIGINT REFERENCES public.assignments(id) ON DELETE CASCADE,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    submission_text TEXT,
    file_paths TEXT[],
    submitted_at TIMESTAMPTZ DEFAULT now(),
    is_late BOOLEAN DEFAULT false,
    status TEXT DEFAULT 'Not Submitted' CHECK (status IN ('Not Submitted', 'Submitted', 'Late', 'Graded')),
    marks_obtained INT,
    teacher_feedback TEXT,
    graded_by UUID REFERENCES public.profiles(id),
    graded_at TIMESTAMPTZ,
    UNIQUE(assignment_id, student_id)
);

-- Exams and assessments
CREATE TABLE IF NOT EXISTS public.exams (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    course_id BIGINT REFERENCES public.courses(id) ON DELETE CASCADE,
    class_id BIGINT REFERENCES public.school_classes(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    exam_type TEXT CHECK (exam_type IN ('Midterm', 'Final', 'Quiz', 'Test', 'Practical', 'Assignment')),
    exam_date TIMESTAMPTZ NOT NULL,
    duration_minutes INT,
    total_marks INT DEFAULT 100,
    instructions TEXT,
    room_number TEXT,
    status TEXT DEFAULT 'Scheduled' CHECK (status IN ('Scheduled', 'In Progress', 'Completed', 'Cancelled')),
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Exam results
CREATE TABLE IF NOT EXISTS public.exam_results (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    exam_id BIGINT REFERENCES public.exams(id) ON DELETE CASCADE,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    marks_obtained INT,
    grade TEXT,
    rank INT,
    status TEXT DEFAULT 'Pending' CHECK (status IN ('Pending', 'Published', 'Corrected')),
    remarks TEXT,
    graded_by UUID REFERENCES public.profiles(id),
    graded_at TIMESTAMPTZ,
    UNIQUE(exam_id, student_id)
);

-- ===============================================================================================
-- 3. ADMISSIONS SYSTEM
-- ===============================================================================================

-- Admissions applications
CREATE TABLE IF NOT EXISTS public.admissions (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    applicant_name TEXT NOT NULL,
    grade TEXT NOT NULL,
    status TEXT DEFAULT 'Pending Review' CHECK (status IN ('Pending Review', 'Documents Requested', 'Approved', 'Rejected', 'Waitlisted')),
    submitted_at TIMESTAMPTZ DEFAULT now(),
    submitted_by UUID REFERENCES public.profiles(id),
    parent_id UUID REFERENCES public.profiles(id),
    parent_name TEXT,
    parent_email TEXT,
    parent_phone TEXT,
    date_of_birth DATE,
    gender TEXT,
    profile_photo_url TEXT,
    medical_info TEXT,
    emergency_contact TEXT,
    application_number TEXT UNIQUE,
    student_user_id UUID REFERENCES public.profiles(id),
    branch_id BIGINT REFERENCES public.school_branches(id),
    previous_school TEXT,
    previous_grade TEXT,
    transport_required BOOLEAN DEFAULT false,
    special_requirements TEXT,
    notes TEXT,
    reviewed_by UUID REFERENCES public.profiles(id),
    reviewed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Document requirements for admissions
CREATE TABLE IF NOT EXISTS public.document_requirements (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    admission_id BIGINT REFERENCES public.admissions(id) ON DELETE CASCADE,
    document_name TEXT NOT NULL,
    status TEXT DEFAULT 'Pending' CHECK (status IN ('Pending', 'Submitted', 'Accepted', 'Rejected', 'Verified')),
    notes_for_parent TEXT,
    rejection_reason TEXT,
    is_mandatory BOOLEAN DEFAULT true,
    document_type TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Uploaded documents for admissions
CREATE TABLE IF NOT EXISTS public.admission_documents (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    requirement_id BIGINT REFERENCES public.document_requirements(id) ON DELETE CASCADE,
    admission_id BIGINT REFERENCES public.admissions(id) ON DELETE CASCADE,
    file_name TEXT NOT NULL,
    storage_path TEXT NOT NULL,
    file_size BIGINT,
    mime_type TEXT,
    uploaded_at TIMESTAMPTZ DEFAULT now(),
    verified_by UUID REFERENCES public.profiles(id),
    verified_at TIMESTAMPTZ
);

-- ===============================================================================================
-- 4. FINANCE & PAYMENTS
-- ===============================================================================================

-- Fee structures
CREATE TABLE IF NOT EXISTS public.fee_structures (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    academic_year TEXT NOT NULL,
    name TEXT NOT NULL,
    target_grade TEXT,
    description TEXT,
    currency TEXT DEFAULT 'INR',
    total_amount DECIMAL(12,2),
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Draft')),
    effective_from DATE,
    effective_to DATE,
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Fee components (tuition, lab, library, etc.)
CREATE TABLE IF NOT EXISTS public.fee_components (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    fee_structure_id BIGINT REFERENCES public.fee_structures(id) ON DELETE CASCADE,
    component_name TEXT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    is_mandatory BOOLEAN DEFAULT true,
    due_date DATE,
    late_fee DECIMAL(8,2) DEFAULT 0,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Student fee assignments
CREATE TABLE IF NOT EXISTS public.student_fee_assignments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    fee_structure_id BIGINT REFERENCES public.fee_structures(id) ON DELETE CASCADE,
    assigned_date DATE DEFAULT CURRENT_DATE,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Waived')),
    discount_percentage DECIMAL(5,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    assigned_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Fee invoices
CREATE TABLE IF NOT EXISTS public.fee_invoices (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    fee_structure_id BIGINT REFERENCES public.fee_structures(id) ON DELETE CASCADE,
    invoice_number TEXT UNIQUE NOT NULL,
    due_date DATE NOT NULL,
    total_amount DECIMAL(12,2) NOT NULL,
    paid_amount DECIMAL(12,2) DEFAULT 0,
    status TEXT DEFAULT 'Pending' CHECK (status IN ('Pending', 'Partial', 'Paid', 'Overdue', 'Cancelled')),
    payment_method TEXT,
    academic_year TEXT,
    description TEXT,
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Fee payments
CREATE TABLE IF NOT EXISTS public.fee_payments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    invoice_id BIGINT REFERENCES public.fee_invoices(id) ON DELETE CASCADE,
    amount DECIMAL(12,2) NOT NULL,
    payment_date TIMESTAMPTZ DEFAULT now(),
    payment_method TEXT CHECK (payment_method IN ('Cash', 'Cheque', 'Online', 'Bank Transfer', 'Card')),
    transaction_id TEXT,
    receipt_number TEXT,
    collected_by UUID REFERENCES public.profiles(id),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Expense tracking
CREATE TABLE IF NOT EXISTS public.expenses (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    expense_date DATE NOT NULL,
    category TEXT NOT NULL,
    subcategory TEXT,
    amount DECIMAL(12,2) NOT NULL,
    vendor_name TEXT,
    description TEXT,
    receipt_url TEXT,
    status TEXT DEFAULT 'Pending' CHECK (status IN ('Pending', 'Approved', 'Rejected', 'Paid')),
    approved_by UUID REFERENCES public.profiles(id),
    approved_at TIMESTAMPTZ,
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ===============================================================================================
-- 5. TRANSPORT MANAGEMENT
-- ===============================================================================================

-- Transport routes
CREATE TABLE IF NOT EXISTS public.transport_routes (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    branch_id BIGINT REFERENCES public.school_branches(id) ON DELETE CASCADE,
    route_name TEXT NOT NULL,
    description TEXT,
    start_location TEXT,
    end_location TEXT,
    estimated_duration_minutes INT,
    fare DECIMAL(8,2),
    capacity INT,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Maintenance')),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Vehicles
CREATE TABLE IF NOT EXISTS public.transport_vehicles (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    route_id BIGINT REFERENCES public.transport_routes(id),
    vehicle_number TEXT UNIQUE NOT NULL,
    vehicle_type TEXT,
    capacity INT,
    driver_id UUID REFERENCES public.profiles(id),
    conductor_id UUID REFERENCES public.profiles(id),
    fuel_type TEXT,
    purchase_date DATE,
    insurance_expiry DATE,
    fitness_expiry DATE,
    status TEXT DEFAULT 'Active' CHECK (status IN ('Active', 'Inactive', 'Maintenance', 'Retired')),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Student transport assignments
CREATE TABLE IF NOT EXISTS public.student_transport_assignments (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    route_id BIGINT REFERENCES public.transport_routes(id) ON DELETE CASCADE,
    pickup_location TEXT,
    drop_location TEXT,
    is_active BOOLEAN DEFAULT true,
    assigned_date DATE DEFAULT CURRENT_DATE,
    assigned_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Transport attendance (pickup/drop tracking)
CREATE TABLE IF NOT EXISTS public.transport_attendance (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    student_id UUID REFERENCES public
