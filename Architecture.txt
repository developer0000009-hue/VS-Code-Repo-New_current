# ===============================================================================================
#  GURUKUL OS - ENTERPRISE SCHOOL MANAGEMENT ARCHITECTURE
#  Version: 6.5.0 (AI-Optimized Build)
#  Last Updated: December 16, 2025
#  Platform: Multi-Tenant Cloud / Institutional Hub
# ===============================================================================================

## ðŸ”¹ 1. SYSTEM ECOSYSTEM

### 1.1. Core Vision
Gurukul OS is a high-density institutional operating system that bridges the gap between administrative overhead and pedagogical excellence. It utilizes a "Unified Identity" model where a single user can hold multiple roles (Parent, Teacher, Admin) across various institutional nodes.

### 1.2. Technology Stack (v6.5)
- **Frontend Core**: React 19 + TypeScript (ESM)
- **Design System**: "Velvet Dark" - Custom Tailwind implementation with Lora (Serif) typography, Glassmorphism (Backdrop-blur), and 60fps hardware-accelerated animations.
- **Intelligence Layer**: Google Gemini API Integration
  - **Gemini 3 Pro**: Complex reasoning, timetable optimization, and faculty compliance auditing.
  - **Gemini 2.5 Flash**: Real-time syllabus generation, homework assistance, and broadcast summarization.
- **Backend Infrastructure**: Supabase Enterprise
  - **Database**: PostgreSQL 15 (Edge-distributed)
  - **Security**: Strict Row-Level Security (RLS) with JWT claim validation.
  - **Handshake Protocol**: AES-256 encrypted verification keys for cross-branch administrative linking.

---

## ðŸ”¹ 2. ARCHITECTURAL LAYERS

### 2.1. The "Handshake" Protocol (Branch Synchronization)
Unlike traditional flat multi-tenancy, Gurukul uses an atomic handshake protocol:
1. **Provisioning**: School Administration generates a 12-character time-bound Access Key (RPC: `generate_branch_access_key`).
2. **Identity Mapping**: Branch Admins enter the key in the `Verification Center`.
3. **Atomic Linking**: The system performs a single-transaction update (RPC: `verify_and_link_branch_admin`) that binds the user profile to the branch ID and activates the institutional node.

### 2.2. The Data Flow (Real-time Sync)
- **Command Center**: Aggregates telemetry from sub-modules (Admissions, Finance, Academics) into a single context-aware dashboard.
- **Contextual Persistence**: Dashboards utilize a `branch_id` state that persists through sub-navigations, ensuring data remains scoped to the selected campus.
- **Audit Logging**: Every administrative action (Attendance, Grading, Finance) is captured in `audit_logs` with a timestamp and user-role context.

---

## ðŸ”¹ 3. MODULE DEEP-DIVE

### 3.1. Admissions & Enrollment
- **Admissions Vault**: Secure storage for student identity documents.
- **Status Pipeline**: 5-stage lifecycle (Enquiry -> Pending Review -> Docs Requested -> Payment Pending -> Admitted).
- **Auto-Provisioning**: Upon admission approval, the system triggers the creation of `student_profiles` and generates a unique institutional Student ID.

### 3.2. Academic Intelligence
- **Syllabus Builder**: AI-driven generation of week-by-week curriculum maps.
- **Timetable Engine**: Draggable grid with conflict detection (Teacher double-booking, Room capacity, Overload alerts).
- **Homework Terminal**: Centralized assignment distribution with file-based submissions and automated late-status calculations.

### 3.3. Financial Ledger
- **Fee Master**: Grade-wise structure creation with multi-frequency components (Monthly, One-time).
- **Student Ledger**: Real-time reconciliation of invoices vs. payments.
- **Expense Dashboard**: Institutional spend tracking with invoice archival.

---

## ðŸ”¹ 4. SECURITY & PERMISSIONS (RBAC)

### 4.1. Permission Matrix (v2.0)
| Module | Super Admin | School Admin | Branch Admin | Teacher | Student | Parent |
| :--- | :---: | :---: | :---: | :---: | :---: | :---: |
| Branches | FULL | FULL | READ | NONE | NONE | NONE |
| Finances | FULL | FULL | READ | NONE | NONE | READ |
| Timetables | FULL | FULL | FULL | READ | READ | READ |
| Admissions | FULL | FULL | FULL | NONE | NONE | FULL* |
| Broadcasts | FULL | FULL | FULL | READ | READ | READ |

*(Full access refers to their own data only)*

### 4.2. Identity Resilience
The system implements a "Self-Healing Identity" check in the `loadUserData` function, ensuring that unconfirmed profiles are immediately guided through the `OnboardingFlow` before any dashboard access is granted.

---

## ðŸ”¹ 5. SCALABILITY & COMPLIANCE

### 5.1. Multi-Tenant Isolation
- **Institutional Isolation**: Data is partitioned by institutional IDs at the database level.
- **Branch Scoping**: RLS policies ensure Branch Admins can never see data from parallel branches within the same school group unless specifically authorized by the Head Office.

### 5.2. Regulatory Adherence
- **Data Portability**: Standardized CSV export for all faculty and student directories.
- **Security Logs**: Session logs and activity feeds for compliance monitoring.
- **Encrypted Storage**: S3-compatible buckets with signed-URL access for sensitive documents.

# ===============================================================================================
#  END OF ARCHITECTURAL DOCUMENTATION
# ===============================================================================================