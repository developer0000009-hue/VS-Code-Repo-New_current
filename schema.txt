
-- ===============================================================================================
--  GURUKUL OS - MASTER SCHEMA
--  Version: 10.3.0 (Infrastructure Restoration)
--  Description: Comprehensive schema including missing Vault/Document relations.
-- ===============================================================================================

-- 1. CORE TABLES
-- -----------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    display_name TEXT,
    phone TEXT,
    role TEXT,
    profile_completed BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    branch_id INT,
    created_at TIMESTAMPTZ DEFAULT now(),
    email_confirmed_at TIMESTAMPTZ
);

CREATE TABLE IF NOT EXISTS public.admissions (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    applicant_name TEXT NOT NULL,
    grade TEXT NOT NULL,
    status TEXT DEFAULT 'Pending Review',
    submitted_at TIMESTAMPTZ DEFAULT now(),
    submitted_by UUID REFERENCES public.profiles(id),
    parent_id UUID REFERENCES public.profiles(id),
    parent_name TEXT,
    parent_email TEXT,
    parent_phone TEXT,
    date_of_birth DATE,
    gender TEXT,
    profile_photo_url TEXT,
    medical_info TEXT,
    emergency_contact TEXT,
    application_number TEXT UNIQUE,
    student_user_id UUID REFERENCES public.profiles(id),
    branch_id INT
);

-- 2. DOCUMENT VAULT INFRASTRUCTURE (Fix for "relation does not exist")
-- -----------------------------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.document_requirements (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    admission_id BIGINT REFERENCES public.admissions(id) ON DELETE CASCADE,
    document_name TEXT NOT NULL,
    status TEXT DEFAULT 'Pending' CHECK (status IN ('Pending', 'Submitted', 'Accepted', 'Rejected', 'Verified')),
    notes_for_parent TEXT,
    rejection_reason TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.admission_documents (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    requirement_id BIGINT REFERENCES public.document_requirements(id) ON DELETE CASCADE,
    admission_id BIGINT REFERENCES public.admissions(id) ON DELETE CASCADE,
    file_name TEXT NOT NULL,
    storage_path TEXT NOT NULL,
    uploaded_at TIMESTAMPTZ DEFAULT now()
);

-- 3. SECURITY (RLS)
-- -----------------------------------------------------------------------------------------------
ALTER TABLE public.document_requirements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admission_documents ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Parents can view their own requirements" ON public.document_requirements;
CREATE POLICY "Parents can view their own requirements" ON public.document_requirements
FOR SELECT TO authenticated
USING (EXISTS (
    SELECT 1 FROM public.admissions a 
    WHERE a.id = admission_id 
    AND (a.parent_id = auth.uid() OR a.submitted_by = auth.uid() OR a.student_user_id = auth.uid())
));

DROP POLICY IF EXISTS "Parents can view their own documents" ON public.admission_documents;
CREATE POLICY "Parents can view their own documents" ON public.admission_documents
FOR SELECT TO authenticated
USING (EXISTS (
    SELECT 1 FROM public.admissions a 
    WHERE a.id = admission_id 
    AND (a.parent_id = auth.uid() OR a.submitted_by = auth.uid() OR a.student_user_id = auth.uid())
));

-- 4. LOGIC INTERFACE (RPCs)
-- -----------------------------------------------------------------------------------------------

-- Deep Document Fetch with Integrity Check
CREATE OR REPLACE FUNCTION public.parent_get_document_requirements()
RETURNS TABLE (
    id BIGINT,
    admission_id BIGINT,
    document_name TEXT,
    status TEXT,
    notes_for_parent TEXT,
    rejection_reason TEXT,
    applicant_name TEXT,
    profile_photo_url TEXT,
    admission_documents JSONB
) LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    RETURN QUERY 
    SELECT 
        dr.id, 
        dr.admission_id, 
        dr.document_name, 
        dr.status::text, 
        dr.notes_for_parent, 
        dr.rejection_reason,
        a.applicant_name,
        a.profile_photo_url,
        COALESCE(
            (SELECT jsonb_agg(ad) FROM public.admission_documents ad WHERE ad.requirement_id = dr.id),
            '[]'::jsonb
        ) as admission_documents
    FROM public.document_requirements dr
    JOIN public.admissions a ON dr.admission_id = a.id
    WHERE a.parent_id = auth.uid() OR a.submitted_by = auth.uid() OR a.student_user_id = auth.uid();
END;
$$;

-- Global Dashboard Stats
CREATE OR REPLACE FUNCTION public.get_parent_dashboard_stats()
RETURNS jsonb LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
    v_total int;
    v_pending int;
    v_approved int;
BEGIN
    SELECT count(*) INTO v_total FROM public.admissions WHERE (submitted_by = auth.uid() OR parent_id = auth.uid());
    SELECT count(*) INTO v_pending FROM public.admissions WHERE (submitted_by = auth.uid() OR parent_id = auth.uid()) AND status IN ('Pending Review', 'Documents Requested');
    SELECT count(*) INTO v_approved FROM public.admissions WHERE (submitted_by = auth.uid() OR parent_id = auth.uid()) AND status = 'Approved';

    RETURN jsonb_build_object(
        'total_applications', COALESCE(v_total, 0),
        'pending_applications', COALESCE(v_pending, 0),
        'approved_applications', COALESCE(v_approved, 0)
    );
END;
$$;

NOTIFY pgrst, 'reload schema';
