
-- ===============================================================================================
--  GURUKUL OS - v22.2.1 FINANCE & FEES MODULE SCHEMA (RECOVERY BUILD)
-- ===============================================================================================

BEGIN;

-- 0. CLEANUP (Fix for ERROR: 42P13: cannot change return type of existing function)
-- Use CASCADE to handle the 2BP01 dependency error with RLS policies
DROP FUNCTION IF EXISTS public.is_admin() CASCADE;

DROP FUNCTION IF EXISTS public.get_finance_dashboard_data(bigint);
DROP FUNCTION IF EXISTS public.record_fee_payment(bigint, numeric, text, text);
DROP FUNCTION IF EXISTS public.get_student_fee_summary_all(bigint);
DROP FUNCTION IF EXISTS public.get_student_finance_details(uuid);
DROP FUNCTION IF EXISTS public.get_payable_invoices_for_student(uuid);

-- 1. Identity Helper (Re-created after CASCADE drop)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.profiles
    WHERE id = auth.uid()
    AND role IN ('School Administration', 'Branch Admin', 'Super Admin', 'Accountant', 'Principal')
  );
END;
$$;

-- 2. Fee Structures (Master Definitions)
CREATE TABLE IF NOT EXISTS public.fee_structures (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    branch_id BIGINT REFERENCES public.school_branches(id),
    name TEXT NOT NULL,
    description TEXT,
    academic_year TEXT NOT NULL,
    target_grade TEXT NOT NULL,
    currency TEXT DEFAULT 'INR',
    status TEXT DEFAULT 'Draft', -- Draft, Active, Archived
    is_active BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Fee Components (Individual items within a structure)
CREATE TABLE IF NOT EXISTS public.fee_components (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    structure_id BIGINT REFERENCES public.fee_structures(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    frequency TEXT NOT NULL, -- One-time, Monthly, Quarterly, Annually
    is_mandatory BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Student Fee Accounts (Binds a student to a structure)
CREATE TABLE IF NOT EXISTS public.student_fee_accounts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    structure_id BIGINT REFERENCES public.fee_structures(id),
    total_billed DECIMAL(12,2) DEFAULT 0,
    total_paid DECIMAL(12,2) DEFAULT 0,
    outstanding_balance DECIMAL(12,2) DEFAULT 0,
    concession_amount DECIMAL(12,2) DEFAULT 0,
    status TEXT DEFAULT 'Pending', -- Pending, Partial, Paid, Overdue
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(student_id, structure_id)
);

-- 5. Fee Invoices (Specific billable installments)
CREATE TABLE IF NOT EXISTS public.fee_invoices (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    account_id BIGINT REFERENCES public.student_fee_accounts(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    amount_paid DECIMAL(12,2) DEFAULT 0,
    due_date DATE NOT NULL,
    status TEXT DEFAULT 'Pending', -- Pending, Paid, Overdue, Partial
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6. Fee Payments (Transaction History)
CREATE TABLE IF NOT EXISTS public.fee_payments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    invoice_id BIGINT REFERENCES public.fee_invoices(id),
    student_id UUID REFERENCES public.profiles(id),
    amount DECIMAL(12,2) NOT NULL,
    payment_date TIMESTAMPTZ DEFAULT NOW(),
    payment_method TEXT NOT NULL, -- Online, Cash, Cheque, Bank Transfer
    transaction_reference TEXT,
    receipt_number TEXT UNIQUE,
    recorded_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 7. School Expenses
CREATE TABLE IF NOT EXISTS public.school_expenses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    branch_id BIGINT REFERENCES public.school_branches(id),
    category TEXT NOT NULL, -- Salary, Maintenance, Utilities, Transport, etc.
    description TEXT NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    vendor_name TEXT,
    expense_date DATE DEFAULT CURRENT_DATE,
    payment_mode TEXT,
    status TEXT DEFAULT 'Approved', -- Pending, Approved, Rejected
    invoice_url TEXT,
    recorded_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS POLICIES (Re-created after CASCADE drop)
ALTER TABLE public.fee_structures ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fee_components ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.student_fee_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fee_invoices ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fee_payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.school_expenses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admins full access to finance" ON public.fee_structures FOR ALL TO authenticated USING (public.is_admin());
CREATE POLICY "Admins full access to components" ON public.fee_components FOR ALL TO authenticated USING (public.is_admin());
CREATE POLICY "Admins full access to fee accounts" ON public.student_fee_accounts FOR ALL TO authenticated USING (public.is_admin());
CREATE POLICY "Admins full access to invoices" ON public.fee_invoices FOR ALL TO authenticated USING (public.is_admin());
CREATE POLICY "Admins full access to payments" ON public.fee_payments FOR ALL TO authenticated USING (public.is_admin());
CREATE POLICY "Admins full access to expenses" ON public.school_expenses FOR ALL TO authenticated USING (public.is_admin());

-- RPC: Get Finance Dashboard Data
CREATE OR REPLACE FUNCTION public.get_finance_dashboard_data(p_branch_id BIGINT DEFAULT NULL)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_total_billed DECIMAL;
    v_total_paid DECIMAL;
    v_total_dues DECIMAL;
    v_online_payments DECIMAL;
BEGIN
    SELECT COALESCE(SUM(total_billed), 0), COALESCE(SUM(total_paid), 0), COALESCE(SUM(outstanding_balance), 0)
    INTO v_total_billed, v_total_paid, v_total_dues
    FROM public.student_fee_accounts
    WHERE (p_branch_id IS NULL OR EXISTS (SELECT 1 FROM public.student_profiles sp WHERE sp.user_id = student_id AND sp.branch_id = p_branch_id));

    SELECT COALESCE(SUM(amount), 0) INTO v_online_payments
    FROM public.fee_payments
    WHERE payment_method = 'Online';

    RETURN jsonb_build_object(
        'revenue_ytd', v_total_paid,
        'pending_dues', v_total_dues,
        'online_payments', v_online_payments
    );
END;
$$;

-- RPC: Get All Student Fee Summary
CREATE OR REPLACE FUNCTION public.get_student_fee_summary_all(p_branch_id BIGINT DEFAULT NULL)
RETURNS TABLE (
    student_id UUID,
    display_name TEXT,
    class_name TEXT,
    total_billed DECIMAL,
    total_paid DECIMAL,
    outstanding_balance DECIMAL,
    overall_status TEXT,
    currency TEXT
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id as student_id,
        p.display_name,
        sc.name as class_name,
        COALESCE(sfa.total_billed, 0) as total_billed,
        COALESCE(sfa.total_paid, 0) as total_paid,
        COALESCE(sfa.outstanding_balance, 0) as outstanding_balance,
        COALESCE(sfa.status, 'Pending') as overall_status,
        COALESCE(fs.currency, 'INR') as currency
    FROM public.profiles p
    JOIN public.student_profiles sp ON p.id = sp.user_id
    LEFT JOIN public.school_classes sc ON sp.assigned_class_id = sc.id
    LEFT JOIN public.student_fee_accounts sfa ON p.id = sfa.student_id
    LEFT JOIN public.fee_structures fs ON sfa.structure_id = fs.id
    WHERE p.role = 'Student'
    AND (p_branch_id IS NULL OR sp.branch_id = p_branch_id);
END;
$$;

-- RPC: Get Student Finance Details (Ledger)
CREATE OR REPLACE FUNCTION public.get_student_finance_details(p_student_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_invoices JSONB;
    v_payments JSONB;
BEGIN
    SELECT jsonb_agg(i) INTO v_invoices FROM (
        SELECT * FROM public.fee_invoices WHERE student_id = p_student_id ORDER BY due_date ASC
    ) i;

    SELECT jsonb_agg(p) INTO v_payments FROM (
        SELECT * FROM public.fee_payments WHERE student_id = p_student_id ORDER BY payment_date DESC
    ) p;

    RETURN jsonb_build_object(
        'invoices', COALESCE(v_invoices, '[]'::jsonb),
        'payments', COALESCE(v_payments, '[]'::jsonb)
    );
END;
$$;

-- RPC: Record Fee Payment (Atomic)
CREATE OR REPLACE FUNCTION public.record_fee_payment(
    p_invoice_id BIGINT,
    p_amount DECIMAL,
    p_method TEXT,
    p_reference TEXT DEFAULT NULL
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_invoice RECORD;
    v_account_id BIGINT;
    v_student_id UUID;
    v_receipt_no TEXT;
BEGIN
    SELECT * INTO v_invoice FROM public.fee_invoices WHERE id = p_invoice_id FOR UPDATE;
    IF NOT FOUND THEN RETURN jsonb_build_object('success', false, 'message', 'Invoice not found'); END IF;
    
    v_account_id := v_invoice.account_id;
    v_student_id := v_invoice.student_id;
    v_receipt_no := 'RCP-' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');

    -- 1. Create Payment Record
    INSERT INTO public.fee_payments (invoice_id, student_id, amount, payment_method, transaction_reference, receipt_number, recorded_by)
    VALUES (p_invoice_id, v_student_id, p_amount, p_method, p_reference, v_receipt_no, auth.uid());

    -- 2. Update Invoice
    UPDATE public.fee_invoices
    SET amount_paid = amount_paid + p_amount,
        status = CASE WHEN amount_paid + p_amount >= amount THEN 'Paid' ELSE 'Partial' END,
        updated_at = NOW()
    WHERE id = p_invoice_id;

    -- 3. Update Account
    UPDATE public.student_fee_accounts
    SET total_paid = total_paid + p_amount,
        outstanding_balance = outstanding_balance - p_amount,
        status = CASE WHEN outstanding_balance - p_amount <= 0 THEN 'Paid' ELSE 'Partial' END,
        updated_at = NOW()
    WHERE id = v_account_id;

    RETURN jsonb_build_object('success', true, 'receipt_number', v_receipt_no);
END;
$$;

-- RPC: Get Payable Invoices
CREATE OR REPLACE FUNCTION public.get_payable_invoices_for_student(p_student_id UUID)
RETURNS TABLE (
    id BIGINT,
    description TEXT,
    amount_due DECIMAL
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        fi.id,
        fi.description,
        (fi.amount - fi.amount_paid) as amount_due
    FROM public.fee_invoices fi
    WHERE fi.student_id = p_student_id
    AND fi.status != 'Paid';
END;
$$;

-- ===============================================================================================
--  PATCH: ADMISSIONS SCHEMA ALIGNMENT
-- ===============================================================================================

-- Fix for Enquiry Promotion Failure: Ensure 'notes' column exists in 'admissions'
DO $$ 
BEGIN 
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'admissions') THEN
        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'admissions' AND column_name = 'notes') THEN
            ALTER TABLE public.admissions ADD COLUMN notes TEXT;
        END IF;
    END IF;
END $$;

COMMIT;
