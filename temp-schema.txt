-- ===============================================================================================
--  GURUKUL OS - IDENTITY MODULE SETUP (v16.3.1)
--  Purpose: High-fidelity user profile registry with automated dependency cleanup.
--  Fix: Added CASCADE to DROP statements to resolve RLS policy dependencies.
-- ===============================================================================================

BEGIN;

-- 1. CLEANUP PROTOCOL
-- CASCADE ensures that dependent policies, views, or foreign keys are removed safely.
DO $$ 
BEGIN
    -- Drop Functions
    DROP FUNCTION IF EXISTS public.switch_active_role(TEXT) CASCADE;
    DROP FUNCTION IF EXISTS public.get_user_completed_roles() CASCADE;
    
    -- Drop Tables with CASCADE to remove dependent RLS policies in other modules
    DROP TABLE IF EXISTS public.student_profiles CASCADE;
    DROP TABLE IF EXISTS public.school_admin_profiles CASCADE;
    DROP TABLE IF EXISTS public.teacher_profiles CASCADE;
    DROP TABLE IF EXISTS public.parent_profiles CASCADE;
    DROP TABLE IF EXISTS public.user_roles CASCADE;
    DROP TABLE IF EXISTS public.profiles CASCADE;

    -- Drop Types
    DROP TYPE IF EXISTS public.app_role CASCADE;
    DROP TYPE IF EXISTS public.gender_type CASCADE;
    DROP TYPE IF EXISTS public.workflow_status CASCADE;
END $$;

-- 2. EXTENSIONS
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 3. IDENTITY ENUMS
CREATE TYPE public.app_role AS ENUM (
    'School Administration', 'Branch Admin', 'Teacher', 
    'Student', 'Parent/Guardian', 'Principal', 
    'HR Manager', 'Academic Coordinator', 'Accountant', 
    'Super Admin', 'Minimal Admin'
);

CREATE TYPE public.gender_type AS ENUM ('Male', 'Female', 'Other', 'Prefer not to say');

CREATE TYPE public.workflow_status AS ENUM (
    'New', 'Pending Review', 'Verified', 'Approved', 
    'Rejected', 'Cancelled', 'Active', 'Inactive', 'On Leave'
);

-- 4. CORE PROFILES TABLE
-- Bridges Supabase Auth with Application Logic
CREATE TABLE public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT UNIQUE NOT NULL,
    display_name TEXT,
    phone TEXT,
    branch_id UUID, -- References school_branches (optional context)
    is_active BOOLEAN DEFAULT true,
    profile_completed BOOLEAN DEFAULT false,
    role public.app_role,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);

-- 5. ROLE REGISTRY
-- Allows a single identity to hold multiple authorized roles
CREATE TABLE public.user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    role public.app_role NOT NULL,
    is_primary BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(user_id, role)
);

-- 6. SUB-PROFILE REGISTRIES
-- Specialized data containers for different institutional roles

CREATE TABLE public.parent_profiles (
    user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
    relationship_to_student TEXT,
    gender public.gender_type,
    number_of_children INTEGER DEFAULT 1,
    address TEXT,
    city TEXT,
    state TEXT,
    country TEXT DEFAULT 'India',
    pin_code TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE public.teacher_profiles (
    user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
    employee_id TEXT UNIQUE,
    department TEXT,
    designation TEXT,
    subject TEXT,
    qualification TEXT,
    experience_years INTEGER,
    date_of_joining DATE,
    employment_status TEXT DEFAULT 'Active',
    employment_type TEXT DEFAULT 'Full-time',
    bio TEXT,
    specializations TEXT,
    profile_picture_url TEXT,
    branch_id UUID,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE public.school_admin_profiles (
    user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
    school_name TEXT,
    address TEXT,
    city TEXT,
    state TEXT,
    country TEXT DEFAULT 'India',
    admin_contact_name TEXT,
    admin_contact_phone TEXT,
    admin_contact_email TEXT,
    onboarding_step TEXT DEFAULT 'profile',
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE public.student_profiles (
    user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
    grade TEXT,
    parent_guardian_details TEXT,
    assigned_class_id UUID,
    branch_id UUID,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 7. IDENTITY DISCOVERY & SWITCHING RPCs

-- Discovery: Strictly checks which roles have established sub-profiles
CREATE OR REPLACE FUNCTION public.get_user_completed_roles()
RETURNS TABLE (
    role_name TEXT,
    is_completed BOOLEAN
) AS $$
DECLARE
    v_user_id UUID;
BEGIN
    v_user_id := auth.uid();
    
    RETURN QUERY
    SELECT 
        ur.role::TEXT as role_name,
        CASE 
            WHEN ur.role = 'Parent/Guardian' THEN EXISTS (SELECT 1 FROM public.parent_profiles WHERE user_id = v_user_id)
            WHEN ur.role = 'Teacher' THEN EXISTS (SELECT 1 FROM public.teacher_profiles WHERE user_id = v_user_id)
            WHEN ur.role = 'School Administration' THEN EXISTS (SELECT 1 FROM public.school_admin_profiles WHERE user_id = v_user_id)
            WHEN ur.role = 'Student' THEN EXISTS (SELECT 1 FROM public.student_profiles WHERE user_id = v_user_id)
            WHEN ur.role = 'Super Admin' THEN TRUE
            ELSE TRUE
        END as is_completed
    FROM public.user_roles ur
    WHERE ur.user_id = v_user_id;
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER;

-- Switching: Atomic switch that synchronizes the profile state
CREATE OR REPLACE FUNCTION public.switch_active_role(p_target_role TEXT)
RETURNS JSONB AS $$
DECLARE
    v_user_id UUID;
    v_role public.app_role;
    v_completed BOOLEAN;
BEGIN
    v_user_id := auth.uid();
    v_role := p_target_role::public.app_role;

    -- Ensure authorization exists
    IF NOT EXISTS (SELECT 1 FROM public.user_roles WHERE user_id = v_user_id AND role = v_role) THEN
        INSERT INTO public.user_roles (user_id, role) VALUES (v_user_id, v_role)
        ON CONFLICT DO NOTHING;
    END IF;

    -- Completion Check
    SELECT 
        CASE 
            WHEN v_role = 'Parent/Guardian' THEN EXISTS (SELECT 1 FROM public.parent_profiles WHERE user_id = v_user_id)
            WHEN v_role = 'Teacher' THEN EXISTS (SELECT 1 FROM public.teacher_profiles WHERE user_id = v_user_id)
            WHEN v_role = 'School Administration' THEN EXISTS (SELECT 1 FROM public.school_admin_profiles WHERE user_id = v_user_id)
            WHEN v_role = 'Student' THEN EXISTS (SELECT 1 FROM public.student_profiles WHERE user_id = v_user_id)
            WHEN v_role = 'Super Admin' THEN TRUE
            ELSE FALSE
        END INTO v_completed;

    -- Commit update
    UPDATE public.profiles 
    SET role = v_role,
        profile_completed = v_completed,
        updated_at = now()
    WHERE id = v_user_id;

    RETURN jsonb_build_object(
        'success', true,
        'role', v_role,
        'profile_restored', v_completed
    );
END;
$$ LANGUAGE plpgsql VOLATILE SECURITY DEFINER;

-- 8. SECURITY (RLS)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Identity: Users can manage own profile" ON public.profiles FOR ALL TO authenticated USING (auth.uid() = id);

ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Identity: Users can view own roles" ON public.user_roles FOR SELECT TO authenticated USING (auth.uid() = user_id);

GRANT USAGE ON SCHEMA public TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;

COMMIT;