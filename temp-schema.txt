
-- ===============================================================================================
-- GURUKUL OS - INQUIRY WORKSPACE PATCH
-- Version: 17.1.0 (Messaging & Persistence Fix)
-- ===============================================================================================

-- 1. CORE TABLE REFINEMENT
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='enquiry_messages' AND column_name='sender_role') THEN
        ALTER TABLE public.enquiry_messages ADD COLUMN sender_role TEXT DEFAULT 'SCHOOL_ADMIN';
    END IF;
END $$;

-- 2. RPC: SEND ENQUIRY MESSAGE (Auto-resolves Parent Link)
CREATE OR REPLACE FUNCTION public.send_enquiry_message(
    p_node_id UUID,
    p_message TEXT
) RETURNS VOID LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
    v_parent_id UUID;
BEGIN
    -- Resolve the parent linked to this inquiry
    SELECT (CASE WHEN parent_id IS NOT NULL THEN parent_id ELSE submitted_by END) INTO v_parent_id
    FROM public.admissions
    WHERE id = p_node_id;

    IF v_parent_id IS NULL THEN
        RAISE EXCEPTION 'Identity Link Failure: No parent associated with this lead node.';
    END IF;

    INSERT INTO public.enquiry_messages (
        admission_id,
        sender_id,
        sender_role,
        message,
        created_at
    ) VALUES (
        p_node_id,
        auth.uid(),
        'SCHOOL_ADMIN',
        p_message,
        now()
    );

    -- Touch the main record for sorting
    UPDATE public.admissions SET updated_at = now() WHERE id = p_node_id;
END;
$$;

-- 3. RPC: UPDATE ENQUIRY LIFECYCLE (Data Persistence)
CREATE OR REPLACE FUNCTION public.update_enquiry_lifecycle(
    p_node_id UUID,
    p_status TEXT,
    p_notes TEXT,
    p_metadata JSONB,
    p_finalize BOOLEAN DEFAULT false
) RETURNS JSONB LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
    v_old_status TEXT;
    v_new_name TEXT;
BEGIN
    SELECT status::text, applicant_name INTO v_old_status, v_new_name FROM public.admissions WHERE id = p_node_id;
    
    v_new_name := COALESCE(p_metadata->>'applicant_name', v_new_name);

    -- Update Core Data
    UPDATE public.admissions
    SET status = p_status::public.admission_status,
        notes = p_notes,
        applicant_name = v_new_name,
        updated_at = now()
    WHERE id = p_node_id;

    -- Log to Timeline if status changed
    IF v_old_status != p_status THEN
        INSERT INTO public.admission_audit_logs (
            admission_id, previous_status, new_status, changed_by, changed_by_name, item_type
        ) VALUES (
            p_node_id, v_old_status, p_status, auth.uid(), 
            (SELECT display_name FROM public.profiles WHERE id = auth.uid()),
            'STATUS_CHANGE'
        );
    END IF;

    RETURN jsonb_build_object('success', true, 'message', 'Node state persisted successfully.');
END;
$$;

-- 4. RPC: GET ENQUIRY TIMELINE (Unified View)
CREATE OR REPLACE FUNCTION public.get_enquiry_timeline(p_node_id UUID)
RETURNS TABLE (
    id UUID,
    item_type TEXT,
    details JSONB,
    created_at TIMESTAMPTZ,
    created_by_name TEXT,
    is_admin BOOLEAN
) LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    RETURN QUERY
    -- Messages
    SELECT 
        m.id,
        'MESSAGE' as item_type,
        jsonb_build_object('message', m.message) as details,
        m.created_at,
        p.display_name as created_by_name,
        (m.sender_role = 'SCHOOL_ADMIN') as is_admin
    FROM public.enquiry_messages m
    JOIN public.profiles p ON m.sender_id = p.id
    WHERE m.admission_id = p_node_id
    
    UNION ALL
    
    -- Status Logs
    SELECT 
        l.id::uuid,
        'STATUS_CHANGE' as item_type,
        jsonb_build_object('old', l.previous_status, 'new', l.new_status) as details,
        l.created_at,
        l.changed_by_name as created_by_name,
        true as is_admin
    FROM public.admission_audit_logs l
    WHERE l.admission_id = p_node_id
    
    ORDER BY created_at ASC;
END;
$$;

NOTIFY pgrst, 'reload schema';
