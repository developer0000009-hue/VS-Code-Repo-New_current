
-- ===============================================================================================
-- GURUKUL OS - PARENT/GUARDIAN PORTAL MASTER SCHEMA
-- Version: 1.9.0 (Relation Integrity Pass)
-- Description: Physically creates missing tables to resolve "relation does not exist" errors.
-- ===============================================================================================

-- 1. SCHEMATIC INFRASTRUCTURE (Ensures tables exist)
-- -----------------------------------------------------------------------------------------------
DO $$ 
BEGIN 
    -- 1.1 Admissions Table Column Guard
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='admissions' AND column_name='status') THEN
        ALTER TABLE public.admissions ADD COLUMN status TEXT DEFAULT 'Pending Review';
    END IF;

    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='admissions' AND column_name='profile_photo_url') THEN
        ALTER TABLE public.admissions ADD COLUMN profile_photo_url TEXT;
    END IF;

    -- 1.2 Document Requirements Table
    CREATE TABLE IF NOT EXISTS public.document_requirements (
        id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
        admission_id BIGINT REFERENCES public.admissions(id) ON DELETE CASCADE,
        document_name TEXT NOT NULL,
        status TEXT DEFAULT 'Pending' CHECK (status IN ('Pending', 'Submitted', 'Accepted', 'Rejected', 'Verified')),
        notes_for_parent TEXT,
        rejection_reason TEXT,
        created_at TIMESTAMPTZ DEFAULT now()
    );

    -- 1.3 Admission Documents Storage Mapping
    CREATE TABLE IF NOT EXISTS public.admission_documents (
        id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
        requirement_id BIGINT REFERENCES public.document_requirements(id) ON DELETE CASCADE,
        admission_id BIGINT REFERENCES public.admissions(id) ON DELETE CASCADE,
        file_name TEXT NOT NULL,
        storage_path TEXT NOT NULL,
        uploaded_at TIMESTAMPTZ DEFAULT now()
    );

    -- 1.4 Security Activation
    ALTER TABLE public.document_requirements ENABLE ROW LEVEL SECURITY;
    ALTER TABLE public.admission_documents ENABLE ROW LEVEL SECURITY;

    -- 1.5 RLS Policies (Idempotent)
    DROP POLICY IF EXISTS "Parents can view their own requirements" ON public.document_requirements;
    CREATE POLICY "Parents can view their own requirements" ON public.document_requirements
    FOR SELECT TO authenticated
    USING (EXISTS (SELECT 1 FROM public.admissions a WHERE a.id = admission_id AND (a.parent_id = auth.uid() OR a.submitted_by = auth.uid())));

END $$;

-- 2. LOGIC INTERFACE (RPCs)
-- -----------------------------------------------------------------------------------------------

-- 2.1 Deep Document Fetch with Integrity Check
CREATE OR REPLACE FUNCTION public.parent_get_document_requirements()
RETURNS TABLE (
    id BIGINT,
    admission_id BIGINT,
    document_name TEXT,
    status TEXT,
    notes_for_parent TEXT,
    rejection_reason TEXT,
    applicant_name TEXT,
    profile_photo_url TEXT,
    admission_documents JSONB
) LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    RETURN QUERY 
    SELECT 
        dr.id, 
        dr.admission_id, 
        dr.document_name, 
        dr.status::text, 
        dr.notes_for_parent, 
        dr.rejection_reason,
        a.applicant_name,
        a.profile_photo_url,
        COALESCE(
            (SELECT jsonb_agg(ad) FROM public.admission_documents ad WHERE ad.requirement_id = dr.id),
            '[]'::jsonb
        ) as admission_documents
    FROM public.document_requirements dr
    JOIN public.admissions a ON dr.admission_id = a.id
    WHERE a.parent_id = auth.uid() OR a.submitted_by = auth.uid();
END;
$$;

-- Refresh PostgREST schema cache
NOTIFY pgrst, 'reload schema';
